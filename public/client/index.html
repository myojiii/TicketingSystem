<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Create Ticket</title>
 <style>
   body { font-family: Arial, sans-serif; padding: 16px; }
   form { max-width: 480px; display: grid; gap: 10px; }
   label { display: flex; flex-direction: column; font-weight: 700; }
   input, textarea { padding: 10px; font-size: 14px; }
   button { padding: 12px; font-size: 14px; cursor: pointer; }
   #status { margin-top: 6px; font-weight: 700; }
 </style>
</head>
<body>
 <h1>Create Ticket</h1>
 <p>Provide a title and description to submit your ticket.</p>
 <form id="ticket-form">
   <label>Ticket Title
     <input name="title" placeholder="Enter a short summary" required>
   </label>
   <label>Ticket Description
     <textarea name="description" rows="4" placeholder="Describe your issue" required></textarea>
   </label>
   <button type="submit">Submit Ticket</button>
   <div id="status"></div>
 </form>


 <script>
   const form = document.getElementById("ticket-form");
   const statusBox = document.getElementById("status");


   const getUserId = async () => {
     const stored = localStorage.getItem("userId");
     if (stored) return stored;


     const email = localStorage.getItem("userEmail");
     if (!email) return null;


     try {
       const res = await fetch(`/api/users/by-email?email=${encodeURIComponent(email)}`);
       if (!res.ok) return null;
       const data = await res.json();
       if (data.userId) {
         localStorage.setItem("userId", data.userId);
         return data.userId;
       }
     } catch (err) {
       return null;
     }
     return null;
   };


   // Prefetch userId if possible
   getUserId();


   form.addEventListener("submit", async (e) => {
     e.preventDefault();
     statusBox.textContent = "Saving...";


     const userId = await getUserId();
     if (!userId) {
       statusBox.textContent = "No userId found. Please log in again.";
       return;
     }


     const data = Object.fromEntries(new FormData(form).entries());
     const payload = {
       title: data.title,
       description: data.description,
       userId,
       email: localStorage.getItem("userEmail") || undefined,
     };


     try {
       const res = await fetch("/api/tickets", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(payload),
       });
       const body = await res.json();
       statusBox.textContent = res.ok ? "Saved!" : (body.message || "Failed");
     } catch (err) {
       statusBox.textContent = "Error saving ticket";
     }
   });
 </script>
</body>
</html>



